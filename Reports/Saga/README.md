# Saga 

1. Для реализаци межсервисного взаимодействия и реализации саги был выбран следующий инструментарий:

   * Kafka - для общения между сервисами.
   * Redis - для хранения состояния саги.
   * MassTransit - библиотека для реализации паттерна.
     
2. Сценарий - подается запрос на создание сообщения и создание/инкременации счетчика не прочитанных сообщений
   
   1) Сообщение попадает в общий топик для иницилизации саги(`init-saga-topic`)
   2) Отправляется запрос на создание или инкременацию в сервис счетчиков(`increment-counter-topic`).
   3) Параллельно создается запрос на создание записи диалога в сервис сообщени(`create-message-topic`).
   4) Если создание сообщения прошло успесшно, возвращается положительный ответ в соответсвущий топик`message-created-topic`.
   5) Если сервис сообщений не смог по какой то причине создать сообщение, например бд была не доступна, то кладется 
      сообщение с отрицательным ответом в топик `message-failed-topic`.
   6) При попадании сообщения в топик `message-failed-topic`, активизируется оркестрируемая сага 
      и шлет компенсирующее действие в топик `decrement-counter-topic` по декриминации счетчика.


     ![saga](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/diagram.png)

3) Если зайти в kafka-ui - `http://localhost:8080/` то можно увидеть все нужные топики.
     
     ![kafka-ui](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/kafka-ui.png)

4) Теперь можно зайти в `http://localhost/swagger/index.html`, авторизироваться и послать запрос на создание чата `/api/Chat/{userid}`

5) Дальше можно посмотреть в Kafka UI в какие топики попали сообщения, в зависимости от воспроизведенного сценария .
     ![kafka-saga](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/kafka-saga.png)

6) Как видно из сообщений сработала сага с компенсиюрущем действием, которая декреминировала
   счетчик в результате провала сохранения сообщения.

7) При создани саги используется одно состояния `WaitingForMessageCreation` для перехода между действиями сохранения 
   сообщения и получение результата от сервиса а так же привязка по CorrelationId который передается в заголовке
   и соединяет между сообщениями для консистенции, все это отображается в репозитории Redis.

   ![redis-saga](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/redis-saga.png)
  
