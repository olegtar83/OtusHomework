# Saga 

1. Для реализаци межсервисного взаимодействия саги был выбран следующий инструментарий:

   * Kafka - для отложенной обработки.
   * Redis - для храненния состояния саги.
   * MassTransit - библиотека для реализации паттерна .

2. Сценарий - подается запрос на создание сообщания и создание млм инкременация счетчика не прочитанных сообщений
   
   1) Сообщение попадает в общий топик для иницилизации саги(`init-saga-topic`)
   2) Отправляется запрос на создание или инкременацию в сервис счетчиков(`increment-counter-topic`).
   3) Параллельно создается запрос на создание записи диалога в сервис сообщени(`create-message-topic`).
   4) Если создание сообщения прошло успесшно, возвращается положительный ответ в соответсвущий топик(`message-created-topic`).
   5) Если сервис сообщений не смог по какой то причине создать сообщение, например бд была не доступна, то кладется сообщение 
      с отрмцательным ответом в топик(`message-failed-topic`).
   6) При попадании сообщения в топик `message-failed-topic`, активизируется оркестрированая сага 
      и шлет компенсируещие действие в топик (`message-failed-topic`) по декриминации счетчика.


     ![saga](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/diagram.png)

3) Для проверки можно зайти в kafka-ui - `http://localhost:8080/`, все нужные топики создались, на данный момент пустые
     
     ![kafka-ui](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/kafka-ui.png)

4) Теперь можно зайти в `http://localhost/swagger/index.html`, авторизироваться и послать запрос на создание чата `/api/Chat/{userid}`

5) Можно зайти в kafka-ui и посмотреть какие сообщения попали в какие топики

     ![kafka-saga](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/kafka-saga.png)

6) Как видно из сообщений сработала сага с компенсиюрущем действием, которая декреминировала
   счетчик в результате провала сохранения сообщения.

7) При создани саги используется одно состояния `WaitingForMessageCreation` для перехода между действиями и 
   привязка по CorrelationId который передается в заголовке и соеденяет между сообщениями, все это отображается в репозитории состояния Redis.

   ![redis-saga](https://github.com/olegtar83/OtusHomework/blob/master/Reports/Saga/redis-saga.png)
  
